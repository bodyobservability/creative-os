#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
cd "$ROOT"

changed="$(git diff --cached --name-only)"
if [[ -z "${changed}" ]]; then
  exit 0
fi

pattern='^(README\.md|docs/|specs/|profiles/.*/(docs|specs)/|notes/|controllers/|ai/|packs/|ableton/)'
if command -v rg >/dev/null 2>&1; then
  match="$(echo "${changed}" | rg -q "${pattern}" && echo yes || echo no)"
else
  match="$(echo "${changed}" | grep -Eq "${pattern}" && echo yes || echo no)"
fi

if [[ "${match}" == "yes" ]]; then
  echo "pre-commit: regenerating checksums..."
  bash tools/checksum_generate.sh
  git add checksums/*.txt
fi
